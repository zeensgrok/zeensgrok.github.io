<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jurnal Forex - Dollar / Cent</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --bg-dark: #111;
      --bg-panel: #222;
      --bg-deep: #1b1b1b;
      --accent: #00ff99;
      --accent-light: #00b33c;
      --text: #eee;
      --profit: #00ff66;
      --loss: #ff3333;
      --border: #444;
    }

    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background-color: var(--bg-dark);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      line-height: 1.5;
    }

    header {
      background-color: var(--bg-panel);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 10px;
      border-bottom: 2px solid rgba(0,255,150,0.05);
      position: sticky;
      top: 0;
      z-index: 50;
      gap: 12px;
    }

    .main-title {
      font-weight: 800;
      color: var(--accent);
      font-size: 24px;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin: 0;
    }

    .tabs {
      display: flex;
      gap: 8px;
    }
    .tabs button {
      background: none;
      border: 1px solid transparent;
      color: var(--text);
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: .18s;
      font-size: 15px;
      font-weight: 600;
    }
    .tabs button:hover { transform: translateY(-2px); }
    .tabs button.active {
      background: var(--accent-light);
      color: #000;
      font-weight: 700;
      border: 1px solid rgba(0,255,150,0.2);
      box-shadow: 0 6px 20px rgba(0,255,100,0.1);
    }

    main {
      padding: 22px;
      max-width: 1100px;
      margin: 0 auto 60px;
    }

    .section { display: none; animation: fadeIn .24s ease; }
    .section.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .risk-box {
      background-color: var(--bg-deep);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,255,100,0.06);
      text-align: center;
      margin-bottom: 18px;
    }
    .value-box {
      display: inline-block;
      background-color: #2a2a2a;
      padding: 8px 14px;
      border-radius: 8px;
      color: var(--accent);
      font-weight: bold;
      margin: 5px;
    }

    form.jurnal-form {
      max-width: 720px;
      margin: 8px auto 18px;
      background-color: var(--bg-panel);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0,255,100,0.03);
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
      color: var(--text);
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background-color: #2a2a2a;
      color: var(--text);
      font-size: 14px;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 8px rgba(0,255,150,0.1);
    }

    button.primary {
      background-color: var(--accent-light);
      color: #000;
      border: none;
      padding: 10px 16px;
      cursor: pointer;
      border-radius: 8px;
      font-weight: 700;
      margin-top: 6px;
      width: 100%;
    }
    button.primary:hover { background-color: var(--accent); transform: scale(1.02); }

    canvas#profitChart {
      display: block;
      width: 100%;
      max-width: 100%;
      height: 260px;
      background-color: var(--bg-panel);
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 0 12px rgba(0,255,0,0.03);
      margin: 18px auto;
    }

    table#historyTable {
      width: 100%;
      margin: 14px auto 22px;
      border-collapse: collapse;
      background-color: var(--bg-panel);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,255,0,0.02);
      font-size: 13px;
    }
    th, td {
      padding: 10px;
      border: 1px solid var(--border);
      text-align: center;
    }
    th { background-color: var(--accent-light); color: #000; font-weight: 700; }
    tr:nth-child(even) td { background-color: #2a2a2a; }

    .profit { color: var(--profit); font-weight: 700; }
    .loss { color: var(--loss); font-weight: 700; }

    .totals {
      max-width: 720px;
      margin: 10px auto 28px;
      background-color: var(--bg-panel);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,255,0,0.02);
    }
    .totals span { display:inline-block; margin: 0 12px; font-weight:700; }

    .export-buttons { text-align: center; margin-top: 12px; }
    .export-buttons button { margin: 6px; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; background:#00cc66; color:#000; font-weight:700; }

    img.screenshot {
      width: 78px; height: 50px; object-fit: cover; border-radius: 6px; cursor: pointer;
      transition: transform .15s, box-shadow .15s; border: 1px solid rgba(255,255,255,0.03);
    }
    img.screenshot:hover { transform: scale(1.12); box-shadow: 0 6px 20px rgba(0,255,120,0.06); }

    .modal {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.8); z-index: 2000;
    }
    .modal.active { display: flex; }
    .modal .box { max-width: 92%; max-height: 90%; background: var(--bg-panel); padding: 10px; border-radius: 8px; }
    .modal img { max-width: 100%; max-height: 80vh; display: block; border-radius: 6px; }

    .notulen-wrap {
      max-width: 720px;
      margin: 8px auto 20px;
      background: var(--bg-panel);
      padding: 14px;
      border-radius: 12px;
    }
    .notulen-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    textarea#notulenArea { width: 100%; min-height: 220px; background: #2a2a2a; border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 8px; resize: vertical; }

    .checklist {
      margin-top: 12px;
      background: var(--bg-deep);
      padding: 10px;
      border-radius: 8px;
    }
    .add-btn { background: var(--accent); color: #000; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 700; }

    .dark-toggle {
      position: absolute;
      left: 20px;
      top: 16px;
      background: none;
      border: none;
      color: var(--accent);
      font-size: 20px;
      cursor: pointer;
    }

    .currency-select {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      justify-content: center;
    }
    .currency-select label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      cursor: pointer;
    }
    .currency-select input[type="radio"] {
      transform: scale(1.3);
    }

    @media (max-width: 820px) {
      .main-title { font-size: 20px; }
      .dark-toggle { position: static; margin-bottom: 8px; }
      header { padding: 12px 10px; gap: 6px; }
      main { padding: 12px; }
      img.screenshot { width: 64px; height: 44px; }
    }
  </style>
</head>
<body>
  <header>
    <button class="dark-toggle" id="darkToggle" title="Toggle Dark Mode">Moon</button>
    <h1 class="main-title">JURNAL FOREX</h1>
    <div class="tabs" role="tablist">
      <button id="tabJurnal" class="active">JURNAL</button>
      <button id="tabNotulen">NOTULEN & CEKLIS</button>
    </div>
  </header>

  <main>
    <!-- JURNAL -->
    <section id="sectionJurnal" class="section active">
      <div class="risk-box">
        <h3 style="margin:0 0 8px 0; color:var(--accent)">Modal & Manajemen Risiko</h3>

        <!-- PILIH MATA UANG -->
        <div class="currency-select">
          <label><input type="radio" name="currency" value="dollar" checked> $ Dollar</label>
          <label><input type="radio" name="currency" value="cent"> ¢ Cent</label>
        </div>

        <input type="number" id="modalAwal" placeholder="Modal awal" step="any" value="10000">
        <label for="riskSelect">Risk Per Trade (%)</label>
        <select id="riskSelect">
          <option value="1">1%</option>
          <option value="2" selected>2%</option>
          <option value="3">3%</option>
          <option value="5">5%</option>
        </select>
        <div style="margin-top:10px;">
          <span class="value-box">Risk: <span id="riskValue">200.00</span> <span id="riskUnit">$</span></span>
          <span class="value-box">Balance: <span id="balanceDisplay">10000.00</span> <span id="balanceUnit">$</span></span>
        </div>
      </div>

      <form id="jurnalForm" class="jurnal-form">
        <label for="date">Tanggal:</label>
        <input type="date" id="date" required>

        <label for="pair">Pair Forex:</label>
        <select id="pair" required>
          <option value="">-- Pilih Pair --</option>
          <option value="XAU/USD">XAU/USD</option>
          <option value="EUR/USD">EUR/USD</option>
          <option value="GBP/USD">GBP/USD</option>
          <option value="USD/JPY">USD/JPY</option>
          <option value="AUD/USD">AUD/USD</option>
          <option value="USD/CAD">USD/CAD</option>
          <option value="USD/CHF">USD/CHF</option>
          <option value="NZD/USD">NZD/USD</option>
        </select>

        <label for="strategy">Strategi:</label>
        <input type="text" id="strategy" placeholder="Contoh: Breakout + RSI" required>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <div>
            <label for="entry">Entry Point:</label>
            <input type="number" id="entry" step="0.00001" required>
          </div>
          <div>
            <label for="exit">Exit Point:</label>
            <input type="number" id="exit" step="0.00001" required>
          </div>
        </div>

        <label for="resultType">Hasil:</label>
        <select id="resultType" required>
          <option value="">-- Pilih Hasil --</option>
          <option value="Profit">Profit</option>
          <option value="Loss">Loss</option>
        </select>

        <label for="amount">Jumlah Profit/Loss:</label>
        <input type="number" id="amount" step="any" placeholder="Contoh: 150.50" required>

        <label for="notes">Catatan:</label>
        <textarea id="notes" rows="3" placeholder="Alasan entry, kesalahan, dll..."></textarea>

        <label for="screenshot">Upload Screenshot (opsional):</label>
        <input type="file" id="screenshot" accept="image/*">

        <button type="submit" class="primary">Simpan Jurnal</button>
      </form>

      <canvas id="profitChart"></canvas>

      <h2 style="text-align:center; color:var(--accent); margin:18px 0 8px;">Riwayat Transaksi</h2>
      <table id="historyTable">
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Pair</th>
            <th>Strategi</th>
            <th>Entry</th>
            <th>Exit</th>
            <th>R:R</th>
            <th>Hasil</th>
            <th>P&L</th>
            <th>Catatan</th>
            <th>SS</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="totals">
        <h3 style="margin:6px 0 8px 0; color:var(--accent)">Statistik Akumulasi</h3>
        <span class="profit">Profit: <span id="totalProfit">0.00</span> <span id="profitUnit">$</span></span>
        <span class="loss">Loss: <span id="totalLoss">0.00</span> <span id="lossUnit">$</span></span>
        <span>Win Rate: <span id="winRate">0%</span></span>
        <span>Rata-rata R:R: <span id="avgRR">0.00</span></span>
        <span>Net P&L: <span id="netResult">0.00</span> <span id="netUnit">$</span></span>
      </div>

      <div class="export-buttons">
        <button id="exportExcel">Ekspor Excel</button>
        <button id="exportPDF">Ekspor PDF</button>
        <button id="clearAll" style="background:#ff6666;color:#fff;">Reset Semua</button>
      </div>
    </section>

    <!-- NOTULEN -->
    <section id="sectionNotulen" class="section">
      <div class="notulen-wrap">
        <div class="notulen-header">
          <div style="display:flex;gap:12px;align-items:center;">
            <h2 style="margin:0;color:var(--accent)">Notulen Harian</h2>
            <select id="notulenDateSelect" style="padding:6px;border-radius:6px;background:#2a2a2a;color:var(--text);border:1px solid var(--border);"></select>
          </div>
          <div>
            <button id="saveNotulenBtn" class="add-btn">Simpan</button>
            <button id="newNotulenBtn" class="add-btn" style="background:#00ccff;">+ Baru</button>
          </div>
        </div>

        <textarea id="notulenArea" placeholder="Tulis notulen hari ini..."></textarea>

        <div class="checklist">
          <h3>Daftar Ceklis</h3>
          <div id="checklistContainer"></div>
          <button class="add-btn" id="addChecklistBtn">+ Tambah Item</button>
          <button id="clearChecklistBtn" class="add-btn" style="background:#ff6666;color:#fff;margin-left:8px;">Kosongkan</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Gambar -->
  <div id="imgModal" class="modal">
    <div class="box">
      <button id="closeModal" style="float:right;background:none;border:none;color:var(--accent);font-weight:700;cursor:pointer;">X</button>
      <img id="modalImg" src="" alt="Screenshot">
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <script>
    // === ELEMENTS ===
    const modalInput = document.getElementById('modalAwal');
    const riskSelect = document.getElementById('riskSelect');
    const currencyRadios = document.querySelectorAll('input[name="currency"]');
    const riskValueDisplay = document.getElementById('riskValue');
    const balanceDisplay = document.getElementById('balanceDisplay');
    const tbody = document.querySelector('#historyTable tbody');
    const form = document.getElementById('jurnalForm');
    const totalProfitEl = document.getElementById('totalProfit');
    const totalLossEl = document.getElementById('totalLoss');
    const winRateEl = document.getElementById('winRate');
    const avgRREl = document.getElementById('avgRR');
    const netResultEl = document.getElementById('netResult');
    const unitElements = {
      risk: document.getElementById('riskUnit'),
      balance: document.getElementById('balanceUnit'),
      profit: document.getElementById('profitUnit'),
      loss: document.getElementById('lossUnit'),
      net: document.getElementById('netUnit')
    };

    // === STATE ===
    let modalAwal = 10000, totalProfit = 0, totalLoss = 0, totalTrades = 0, winTrades = 0, totalRR = 0;
    let isCent = false;

    // === CURRENCY HANDLING ===
    function updateCurrency() {
      isCent = document.querySelector('input[name="currency"]:checked').value === 'cent';
      const symbol = isCent ? '¢' : '$';
      const step = isCent ? '1' : '0.01';
      const placeholder = isCent ? 'Contoh: 150000' : 'Contoh: 150.50';

      // Update input
      modalInput.step = step;
      document.getElementById('amount').step = step;
      document.getElementById('amount').placeholder = placeholder;

      // Update labels
      Object.values(unitElements).forEach(el => el.textContent = symbol);

      // Update values
      updateRiskAndBalance();
      rebuildChart();
      updateTableUnits();
    }

    function updateTableUnits() {
      document.querySelectorAll('#historyTable th').forEach(th => {
        if (th.textContent.includes('P&L')) {
          th.textContent = `P&L (${isCent ? '¢' : '$'})`;
        }
      });
    }

    currencyRadios.forEach(radio => radio.addEventListener('change', updateCurrency));

    // === UPDATE RISK & BALANCE ===
    function updateRiskAndBalance() {
      modalAwal = parseFloat(modalInput.value) || 0;
      const riskPercent = parseFloat(riskSelect.value);
      const risk = (modalAwal * riskPercent) / 100;

      riskValueDisplay.textContent = isCent ? Math.round(risk) : risk.toFixed(2);

      const net = totalProfit - totalLoss;
      const balance = modalAwal + net;

      balanceDisplay.textContent = isCent ? Math.round(balance) : balance.toFixed(2);
      totalProfitEl.textContent = isCent ? Math.round(totalProfit) : totalProfit.toFixed(2);
      totalLossEl.textContent = isCent ? Math.round(totalLoss) : totalLoss.toFixed(2);
      netResultEl.textContent = isCent ? Math.round(net) : net.toFixed(2);
      winRateEl.textContent = totalTrades > 0 ? ((winTrades / totalTrades) * 100).toFixed(1) + '%' : '0%';
      avgRREl.textContent = totalTrades > 0 ? (totalRR / totalTrades).toFixed(2) : '0.00';
    }

    // === CHART ===
    const ctx = document.getElementById('profitChart').getContext('2d');
    const profitData = { labels: [], datasets: [{ label: 'Saldo', data: [], borderColor: '#00ff66', backgroundColor: 'rgba(0,255,100,0.1)', borderWidth: 2, tension: 0.3 }] };
    const chart = new Chart(ctx, { type: 'line', data: profitData, options: { responsive: true, scales: { y: { beginAtZero: false } } } });

    function rebuildChart() {
      profitData.labels = ['Awal'];
      profitData.datasets[0].data = [modalAwal];
      let balance = modalAwal;
      tbody.querySelectorAll('tr').forEach(row => {
        const plText = row.cells[7].textContent.replace(/[^\d.-]/g, '');
        const pl = parseFloat(plText);
        balance += pl;
        profitData.labels.push(row.cells[0].textContent);
        profitData.datasets[0].data.push(balance);
      });
      chart.options.plugins.title = { display: true, text: `Saldo (${isCent ? '¢' : '$'})`, color: '#eee' };
      chart.update();
    }

    // === SAVE / LOAD ===
    function saveAll() {
      localStorage.setItem('jurnalHTML', tbody.innerHTML);
      localStorage.setItem('stats', JSON.stringify({ totalProfit, totalLoss, totalTrades, winTrades, totalRR }));
      localStorage.setItem('modalAwal', modalAwal);
      localStorage.setItem('riskSelect', riskSelect.value);
      localStorage.setItem('currency', isCent ? 'cent' : 'dollar');
    }

    function loadAll() {
      modalInput.value = localStorage.getItem('modalAwal') || '10000';
      riskSelect.value = localStorage.getItem('riskSelect') || '2';
      const savedCurrency = localStorage.getItem('currency') || 'dollar';
      document.querySelector(`input[value="${savedCurrency}"]`).checked = true;
      isCent = savedCurrency === 'cent';

      updateCurrency();

      const saved = localStorage.getItem('jurnalHTML');
      if (saved) tbody.innerHTML = saved;

      const stats = JSON.parse(localStorage.getItem('stats') || '{}');
      totalProfit = stats.totalProfit || 0;
      totalLoss = stats.totalLoss || 0;
      totalTrades = stats.totalTrades || 0;
      winTrades = stats.winTrades || 0;
      totalRR = stats.totalRR || 0;

      rebuildChart();
      updateRiskAndBalance();
      attachRowActions();
      attachImageClickHandlers();
    }

    // === FORM SUBMIT ===
    form.addEventListener('submit', e => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('amount').value);
      if (amount <= 0) return alert('Jumlah harus > 0!');

      const risk = (modalAwal * parseFloat(riskSelect.value)) / 100;
      const rr = risk > 0 ? amount / risk : 0;

      const row = document.createElement('tr');
      const result = document.getElementById('resultType').value;
      const pl = result === 'Loss' ? -amount : amount;
      const displayPL = isCent ? Math.round(pl) : pl.toFixed(2);
      const sign = pl > 0 ? '+' : '';

      row.innerHTML = `
        <td>${document.getElementById('date').value}</td>
        <td>${document.getElementById('pair').value}</td>
        <td>${document.getElementById('strategy').value}</td>
        <td>${document.getElementById('entry').value}</td>
        <td>${document.getElementById('exit').value}</td>
        <td>${rr.toFixed(2)}</td>
        <td class="${result === 'Profit' ? 'profit' : 'loss'}">${result}</td>
        <td class="${result === 'Profit' ? 'profit' : 'loss'}">${sign}${displayPL}</td>
        <td style="max-width:180px;white-space:pre-wrap;">${escapeHtml(document.getElementById('notes').value)}</td>
        <td id="ssCell">-</td>
        <td>
          <button class="action-btn edit-btn" title="Edit">Edit</button>
          <button class="action-btn delete-btn" title="Hapus">Delete</button>
        </td>
      `;

      const file = document.getElementById('screenshot').files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          row.querySelector('#ssCell').innerHTML = `<img src="${e.target.result}" class="screenshot" alt="SS">`;
          tbody.appendChild(row);
          finalizeAdd(pl, result, rr);
        };
        reader.readAsDataURL(file);
      } else {
        tbody.appendChild(row);
        finalizeAdd(pl, result, rr);
      }
    });

    function finalizeAdd(pl, result, rr) {
      totalTrades++;
      if (result === 'Profit') { totalProfit += Math.abs(pl); winTrades++; }
      else { totalLoss += Math.abs(pl); }
      totalRR += rr;
      rebuildChart();
      updateRiskAndBalance();
      saveAll();
      attachRowActions();
      attachImageClickHandlers();
      form.reset();
      document.getElementById('date').value = today();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // === ROW ACTIONS ===
    function attachRowActions() {
      tbody.querySelectorAll('tr').forEach(row => {
        const edit = row.querySelector('.edit-btn');
        const del = row.querySelector('.delete-btn');
        if (edit && !edit.dataset.bound) {
          edit.dataset.bound = '1';
          edit.onclick = () => editRow(row);
        }
        if (del && !del.dataset.bound) {
          del.dataset.bound = '1';
          del.onclick = () => deleteRow(row);
        }
      });
    }

    function editRow(row) {
      const cells = row.cells;
      document.getElementById('date').value = cells[0].textContent;
      document.getElementById('pair').value = cells[1].textContent;
      document.getElementById('strategy').value = cells[2].textContent;
      document.getElementById('entry').value = cells[3].textContent;
      document.getElementById('exit').value = cells[4].textContent;
      document.getElementById('resultType').value = cells[6].textContent;
      document.getElementById('amount').value = Math.abs(parseFloat(cells[7].textContent.replace(/[^\d.-]/g, '')));
      document.getElementById('notes').value = cells[8].innerText;
      deleteRow(row);
    }

    function deleteRow(row) {
      if (!confirm('Hapus transaksi ini?')) return;
      const plText = row.cells[7].textContent.replace(/[^\d.-]/g, '');
      const pl = parseFloat(plText);
      const result = row.cells[6].textContent;
      const rr = parseFloat(row.cells[5].textContent);
      if (result === 'Profit') { totalProfit -= Math.abs(pl); winTrades--; }
      else { totalLoss -= Math.abs(pl); }
      totalTrades--;
      totalRR -= rr;
      row.remove();
      rebuildChart();
      updateRiskAndBalance();
      saveAll();
    }

    // === EVENT LISTENERS ===
    modalInput.addEventListener('input', updateRiskAndBalance);
    riskSelect.addEventListener('change', updateRiskAndBalance);

    // === EXPORT ===
    document.getElementById('exportExcel').onclick = () => {
      const wb = XLSX.utils.table_to_book(document.getElementById('historyTable'));
      XLSX.writeFile(wb, `Jurnal_Forex_${isCent ? 'Cent' : 'Dollar'}.xlsx`);
    };

    document.getElementById('exportPDF').onclick = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l');
      doc.text(`Jurnal Forex (${isCent ? 'Cent' : 'Dollar'})`, 140, 15, null, null, 'center');
      doc.autoTable({ html: '#historyTable', startY: 25 });
      doc.save(`Jurnal_Forex_${isCent ? 'Cent' : 'Dollar'}.pdf`);
    };

    document.getElementById('clearAll').onclick = () => {
      if (confirm('Yakin reset SEMUA data?')) {
        localStorage.clear();
        location.reload();
      }
    };

    // === IMAGE MODAL ===
    const modal = document.getElementById('imgModal');
    const modalImg = document.getElementById('modalImg');
    function attachImageClickHandlers() {
      document.querySelectorAll('img.screenshot').forEach(img => {
        img.onclick = () => {
          modalImg.src = img.src;
          modal.classList.add('active');
        };
      });
    }
    document.getElementById('closeModal').onclick = () => modal.classList.remove('active');
    modal.onclick = e => { if (e.target === modal) modal.classList.remove('active'); };

    // === NOTULEN (Ringkas) ===
    const notulenArea = document.getElementById('notulenArea');
    const notulenDateSelect = document.getElementById('notulenDateSelect');
    const checklistContainer = document.getElementById('checklistContainer');

    function getKey(prefix, date) { return `${prefix}_${date}`; }
    function today() { return new Date().toISOString().split('T')[0]; }

    function populateDateSelect() {
      const dates = Object.keys(localStorage).filter(k => k.startsWith('notulen_')).map(k => k.replace('notulen_', ''));
      notulenDateSelect.innerHTML = '';
      dates.sort().reverse().forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = new Date(d).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
        notulenDateSelect.appendChild(opt);
      });
      if (!dates.includes(today())) {
        const opt = document.createElement('option');
        opt.value = today();
        opt.textContent = 'Hari Ini';
        opt.selected = true;
        notulenDateSelect.prepend(opt);
      }
    }

    function loadNotulen() {
      const date = notulenDateSelect.value || today();
      notulenArea.value = localStorage.getItem(getKey('notulen', date)) || '';
      loadChecklist(date);
      populateDateSelect();
    }

    function saveNotulen() {
      const date = notulenDateSelect.value || today();
      localStorage.setItem(getKey('notulen', date), notulenArea.value);
      saveChecklist(date);
      alert('Notulen tersimpan!');
    }

    document.getElementById('saveNotulenBtn').onclick = saveNotulen;
    document.getElementById('newNotulenBtn').onclick = () => {
      notulenDateSelect.value = today();
      notulenArea.value = '';
      checklistContainer.innerHTML = '';
      saveNotulen();
      loadNotulen();
    };

    function createChecklistItem(text = 'Item baru', done = false, date) {
      const div = document.createElement('div');
      div.className = 'checklist-item';
      div.draggable = true;
      div.innerHTML = `<input type="checkbox" ${done?'checked':''}><span contenteditable="true">${text}</span><button class="del">×</button>`;
      div.querySelector('input').onchange = () => saveChecklist(date);
      div.querySelector('span').oninput = () => saveChecklist(date);
      div.querySelector('.del').onclick = () => { div.remove(); saveChecklist(date); };
      checklistContainer.appendChild(div);
    }

    function loadChecklist(date) {
      checklistContainer.innerHTML = '';
      const data = JSON.parse(localStorage.getItem(getKey('checklist', date)) || '[]');
      data.forEach(item => createChecklistItem(item.text, item.done, date));
    }

    function saveChecklist(date) {
      const items = [];
      checklistContainer.querySelectorAll('.checklist-item').forEach(el => {
        items.push({ text: el.querySelector('span').textContent, done: el.querySelector('input').checked });
      });
      localStorage.setItem(getKey('checklist', date), JSON.stringify(items));
    }

    document.getElementById('addChecklistBtn').onclick = () => createChecklistItem('Item baru', false, notulenDateSelect.value || today());
    document.getElementById('clearChecklistBtn').onclick = () => {
      if (confirm('Hapus semua ceklis?')) {
        checklistContainer.innerHTML = '';
        saveChecklist(notulenDateSelect.value || today());
      }
    };

    notulenDateSelect.onchange = loadNotulen;

    // === TAB NAVIGATION ===
    document.getElementById('tabJurnal').onclick = () => {
      document.getElementById('tabJurnal').classList.add('active');
      document.getElementById('tabNotulen').classList.remove('active');
      document.getElementById('sectionJurnal').classList.add('active');
      document.getElementById('sectionNotulen').classList.remove('active');
    };
    document.getElementById('tabNotulen').onclick = () => {
      document.getElementById('tabNotulen').classList.add('active');
      document.getElementById('tabJurnal').classList.remove('active');
      document.getElementById('sectionNotulen').classList.add('active');
      document.getElementById('sectionJurnal').classList.remove('active');
      loadNotulen();
    };

    // === INIT ===
    setInterval(saveAll, 5000);
    window.onload = () => {
      document.getElementById('date').value = today();
      loadAll();
      populateDateSelect();
      loadNotulen();
    };

    // === DARK MODE ===
    document.getElementById('darkToggle').onclick = () => {
      const isDark = document.body.style.filter;
      document.body.style.filter = isDark ? '' : 'invert(1) hue-rotate(180deg)';
    };
  </script>
</body>
</html>